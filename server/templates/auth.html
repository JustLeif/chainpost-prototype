<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.6"
        integrity="sha384-FhXw7b6AlE/jyjlZH5iHa/tTe9EpJ1Y55RjcgPbjeWMskSxZt1v9qkxLJWNJaGni"
        crossorigin="anonymous"></script>
    <script src="/static/js/cardano_serialization_lib.asm.js" type="module"></script>
    <script src="/static/js/cardano_serialization_lib.js" type="module"></script>
    <script src="/static/js/cardano_serialization_lib_bg.js" type="module"></script>
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <link href='https://fonts.googleapis.com/css?family=Assistant' rel='stylesheet'>
    <style>
        body {
            font-family: 'Assistant';
        }

        .gelatine {
            animation: gelatine .5s forwards
        }

        @keyframes gelatine {

            from,
            to {
                transform: scale(1, 1);
            }

            25% {
                transform: scale(0.9, 1.1);
            }

            50% {
                transform: scale(1.1, 0.9);
            }

            75% {
                transform: scale(0.95, 1.05);
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            '100': '#9c27b0',
                            '300': '#b55ec2',
                            '500': '#cc8dd4',
                            '600': '#d7a4dd'
                        },
                        dark: {
                            '100': '#121212',
                            '200': '#282828',
                            '300': '#3f3f3f'
                        },
                        white: '#FFFFFF',
                        gray: '#8b8b8b'
                    }
                }
            }
        }
    </script>

</head>

<body class="bg-dark-100">
    <a type="button" href="{{domain}}/app/home"
        class="flex flex-row hover:text-primary-500 items-center text-3xl mt-2 ml-4 md:mt-4 md:ml-6 px-4 py-4 font-semibold rounded text-primary-600">
        <div class="pr-2">Chainpost</div>
        <svg fill="#d7a4dd" height="28px" width="28px" version="1.1" id="Capa_1"
            xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 31.891 31.891" xml:space="preserve">
            <g>
                <path d="M30.543,5.74l-4.078-4.035c-1.805-1.777-4.736-1.789-6.545-0.02l-4.525,4.414c-1.812,1.768-1.82,4.648-0.02,6.424
		l2.586-2.484c-0.262-0.791,0.061-1.697,0.701-2.324l2.879-2.807c0.912-0.885,2.375-0.881,3.275,0.01l2.449,2.42
		c0.9,0.891,0.896,2.326-0.01,3.213l-2.879,2.809c-0.609,0.594-1.609,0.92-2.385,0.711l-2.533,2.486
		c1.803,1.781,4.732,1.789,6.545,0.02l4.52-4.41C32.34,10.396,32.346,7.519,30.543,5.74z" />
                <path d="M13.975,21.894c0.215,0.773-0.129,1.773-0.752,2.381l-2.689,2.627c-0.922,0.9-2.414,0.895-3.332-0.012l-2.498-2.461
		c-0.916-0.906-0.91-2.379,0.012-3.275l2.691-2.627c0.656-0.637,1.598-0.961,2.42-0.689l2.594-2.57
		c-1.836-1.811-4.824-1.82-6.668-0.02l-4.363,4.26c-1.846,1.803-1.855,4.734-0.02,6.549l4.154,4.107
		c1.834,1.809,4.82,1.818,6.668,0.018l4.363-4.26c1.844-1.805,1.852-4.734,0.02-6.547L13.975,21.894z" />
                <path d="M11.139,20.722c0.611,0.617,1.611,0.623,2.234,0.008l7.455-7.416c0.621-0.617,0.625-1.615,0.008-2.234
        c-0.613-0.615-1.611-0.619-2.23-0.006l-7.457,7.414C10.529,19.103,10.525,20.101,11.139,20.722z" />
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
                <g></g>
            </g>
        </svg>
    </a>

    <div class="flex justify-center items-center text-center h-screen">
        <div class="flex flex-col mb-12 max-w-md p-6 rounded-md sm:p-10">
            <div class="mb-8 text-center items-center justify-center">
                <div class="pb-5 text-mb flex text-white justify-center text-center items-center">
                    <p class="pr-1">Authenticate with a </p>
                    <svg width="20" height="20" viewBox="0 0 2000 1848" class="fill-white justify-center">
                        <path
                            d="M975.46 5.46c43.59-22.73 96.8 30 73.64 73.55-13.45 35.5-64.45 44.94-90.5 17.88C931 70.92 940 19.59 975.46 5.46M506.61 56c26.48-10.9 60 13.36 57.3 42.22 2.81 31.33-35.5 54.39-62.49 39.5-35.76-13.85-31.67-71.9 5.19-81.72M1466.87 138.6c-41.38-5-47.93-70.06-8.09-83.16 30.9-15.07 59.25 13.19 63.77 42.48-6.48 25.01-27.42 47.91-55.68 40.68M613.29 255.55c44.27-28 107.44 13.7 100.63 65.12-2.3 51.92-71.26 82-110.17 46.9-37.62-27.57-31.92-90.82 9.54-112.02M1289.1 285.26c19.75-50.9 99.78-52.44 122.26-2.89 22.22 38.56-5.11 86.31-44.7 99.42-52.44 9.79-102.25-46.9-77.56-96.53M919 378.9c-.43-43.75 39.42-76.35 81-79.33 27.58 5.53 57.64 17.28 69.47 45.11 22.05 38.39 2.47 91.25-37.37 108.87-18.22 10.21-39.76 6.38-59.6 5.19-30.33-14.89-55.87-44.09-53.5-79.84M221.75 442.65c40.44-24.86 95 20.51 79.69 64.44-8.43 38-59.51 53.46-88.71 29.2-31.17-22.73-26.23-77.38 9.02-93.64M1719 442.57c34.31-26.64 90.93 3.92 86.84 47.24 2.3 39.5-46.65 69.29-80.71 48.95-37.51-16.86-41.34-74.57-6.13-96.19M1115.08 521.22c56.62-20.34 123.87 4 156.14 54.48 42.57 61.71 19.92 155.69-46.14 191.1-68.45 41.88-168.4 6.38-193.68-70.06-28.7-68.43 13.11-154.07 83.68-175.52M782.88 527.95c62.75-29.62 147.2-4.77 177.51 59.42 35.67 62.48 8.09 149.48-55.68 181.74-63.85 36.26-153.93 8.77-184.83-58.31-34.65-64.87-3.88-152.98 63-182.85M450.25 641.67c4.77-40.43 42.91-66.74 81.39-69.46 41.46 5 74.58 37.2 79.09 79.16-2.72 41.54-34.82 82.14-78.84 81.89-48.43 4.17-90.89-44.01-81.64-91.59M1432.73 581c49.72-28.94 118.76 13.19 116.55 70.31 3.41 60.52-73 103.17-122.51 67.67-51.43-29.56-47.42-112.81 5.96-137.98M647.69 794.3c58.15-16 124.64 11.41 153.16 64.86 31.24 53.8 18.47 128.54-30.05 168-62.23 57.88-177 34.64-210.12-44.35-38.06-72.41 8.17-169.45 87.01-188.51M1277.78 794c56.53-16.17 122.94 5.62 153.33 57.12 40.18 58.9 21 146.75-38.82 184.72-62.66 44.09-159.72 20.94-194.2-48-41.8-71.31.26-172.09 79.69-193.84M273.68 861.2c50.23-19 105.91 36.43 85.56 86.23-12.43 45.37-76.37 62.14-109.4 28.69-38.65-31.41-24.34-101.3 23.84-114.92M1635.18 933.47c-1.45-41.62 29-78.48 71.68-80.78 34.4 5.45 67.85 33.2 65.13 70.65 3.15 49.46-56.45 83.08-98.59 59.84-19.75-10.04-29.88-30.3-38.22-49.71M26.7 885.63c30.22-13.19 67.6 13 60.7 46.56-1.62 38-57.72 52.61-78.33 20.86C-9.14 931 1.76 897 26.7 885.63zM1932.13 884.87c21.28-15.15 55.42-4.26 63.85 20.6 14.3 27.15-11.92 64.35-42.48 59.76-42.9 3.91-56.78-61.47-21.37-80.36M811.83 1067.28c79.52-20.68 165 45.63 165.5 127.51 5.19 82.74-79 156.11-160.4 137-62.92-10.13-112.29-70.74-110.25-134.32-.17-60.81 45.72-117.33 105.15-130.19M1126.75 1067.11c80.71-22.56 168.74 44.94 167.46 128.71 4.26 81.21-77.3 152.11-157 136-75-9.7-130.34-92.1-109.4-164.88 10.57-48.5 51.09-87.94 98.94-99.83M519.56 1117.51c55.85-9.53 108.21 52.78 85.56 105.81-16.52 56.51-98.76 71.84-135.12 25.68-42.65-44.33-10.81-125.37 49.56-131.49M1443.11 1120c49.8-20.86 110.93 22.22 107.1 76.27 2 59.5-73.47 100.53-122.17 65.8-55.16-31.18-45.12-122.94 15.07-142.07M1701.25 1378.92c-19.5-36.35 15.92-84.53 56.28-77.8 20.09-.34 34.14 15.49 47 28.77 2.64 21.54 7.07 47.24-10.81 63.84-24.28 30.73-79.28 21.96-92.47-14.81M221.58 1311.24c37.72-25.11 92 12.34 83.52 56.44-4.51 39-53.64 61.29-86 39.16-34.73-20.09-33.45-77.29 2.48-95.6M966.78 1392.88c49.38-21.79 112.29 21.2 107.61 75.59 3.66 60.1-74.15 101.72-122.43 65.63-53.63-30.99-44.69-122.16 14.82-141.22M621.63 1473.4c42.06-22.13 98.5 16.09 94.67 63.16 1.28 38.65-36.44 71.59-74.58 65.88-31.59-.68-52.19-29-62.32-55.93.52-29.35 12.6-62.04 42.23-73.11M1320.77 1474.08c43.25-26.73 104.72 11.66 100.63 62 1.11 52.61-68.36 86.31-108.63 51.75-38.99-27.09-34.23-92.21 8-113.75M1442.35 1774.65c-19.24-29.11 3.41-64.18 34.65-70.82 25.12 5.11 51.68 24 46.4 53.12-3.66 39.41-61.3 51.5-81.05 17.7M477.24 1749.37c7.66-23.07 26.22-46 53.38-40 39.59 2.81 51.34 62.48 16.69 80.87-31.16 21.01-67.31-7.76-70.07-40.87M942.85 1775.84c7.58-34.13 51.76-50.73 80.88-32.6 19.24 8.26 24.86 29.79 29.8 48.09-2.64 9.53-5 19.07-7.32 28.6-11.92 14.13-27.24 28.26-47.08 27.75-36.87 4.32-70.13-37.36-56.28-71.84" />
                    </svg>
                    <p class="pl-1">Cardano Wallet</p>
                </div>
                <div class="grid grid-cols-2 gap-4" id="connect_wallets">
                </div>
                <a href="https://www.lace.io/" target="_blank"><button type="button"
                        class="mt-10 hover:text-primary-600 px-4 py-1 font-semibold border rounded text-primary-500">Get
                        a
                        Cardano Wallet</button></a>
            </div>
            <div id="error"></div>
        </div>
    </div>
    <script>
        async function signData(wallet) {
            const csl = await import("/static/js/cardano_serialization_lib_bg.js");
            const networkId = await wallet.getNetworkId();
            const changeAddrHex = await wallet.getChangeAddress();
            // derive the stake address from the change address to be sure we are getting
            // the stake address of the currently active account.
            const changeAddress = csl.Address.from_bytes(window.buffer.Buffer.from(changeAddrHex, 'hex'));
            const stakeCredential = csl.BaseAddress.from_address(changeAddress)?.stake_cred();
            let stakeAddress;
            if (stakeCredential) {
                stakeAddress = csl.RewardAddress.new(networkId, stakeCredential).to_address();
                const stakeAddrHex = stakeAddress.to_hex();
                const stakeAddrBech32 = stakeAddress.to_bech32();
                const sigData = await wallet.signData(stakeAddrHex, window.buffer.Buffer.from(`chainpost_auth ${stakeAddrBech32}`).toString("hex"));
                console.log(sigData);
                // Send sigdata to the server
                let domain = "{{ domain }}";
                const res = await fetch(`${domain}/api/auth/cardano?signature=${sigData.signature}&key=${sigData.key}`)
                console.log(res)
                if(res.status === 200) {
                    window.location.replace("{{ domain }}/app/home");
                }
            } else {
                throw new Error;
            }
        }
        if (window.cardano !== undefined) {
            const connect_wallets_grid = document.getElementById("connect_wallets")
            try {
                const yoroi_button_html = `<button id="yoroi_button" class="w-30 h-30 hover:bg-dark-200 flex flex-col items-center justify-center bg-dark-300 rounded-lg p-4"> <img class="w-full h-full object-cover" src="${window.cardano.yoroi.icon}"><p class="mt-4 text-lg outline text-primary-600 font-semibold rounded-md p-1 pr-2 pl-2">Yoroi Wallet</p></button>`
                const temp_element = document.createElement("div")
                temp_element.innerHTML = yoroi_button_html
                var fragment = document.createDocumentFragment();
                while (temp_element.firstChild) {
                    fragment.appendChild(temp_element.firstChild);
                }
                connect_wallets_grid.appendChild(fragment)
                const yoroi_button = document.getElementById("yoroi_button")
                yoroi_button.addEventListener("click", () => {
                    window.cardano.yoroi.enable().then(async (wallet) => {
                        await signData(wallet)
                    })
                })
            } catch (e) {}
            try {
                const lace_button_html = `<button id="lace_button" class="w-30 h-30 hover:bg-dark-200 flex flex-col items-center justify-center bg-dark-300 rounded-lg p-4"> <img class="w-full h-full object-cover" src="${window.cardano.lace.icon}"><p class="mt-4 text-lg outline text-primary-600 font-semibold rounded-md p-1 pr-2 pl-2">Lace Wallet</p></button>`
                const temp_element = document.createElement("div")
                temp_element.innerHTML = lace_button_html
                var fragment = document.createDocumentFragment();
                while (temp_element.firstChild) {
                    fragment.appendChild(temp_element.firstChild);
                }
                connect_wallets_grid.appendChild(fragment)
            } catch (e) {}
            try {
                const nami_button_html = `<button id="nami_button" class="w-30 h-30 hover:bg-dark-200 flex flex-col items-center justify-center bg-dark-300 rounded-lg p-4"> <img class="w-full h-full object-cover" src="${window.cardano.nami.icon}"><p class="mt-4 text-lg outline text-primary-600 font-semibold rounded-md p-1 pr-2 pl-2">Nami Wallet</p></button>`
                const temp_element = document.createElement("div")
                temp_element.innerHTML = nami_button_html
                var fragment = document.createDocumentFragment();
                while (temp_element.firstChild) {
                    fragment.appendChild(temp_element.firstChild);
                }
                connect_wallets_grid.appendChild(fragment)
            } catch (e) {}
            if (window.cardano.lace === undefined && window.cardano.nami === undefined && window.cardano.yoroi === undefined) {
                const main_menu = document.getElementById("error")
                const error_html = `<div class=" gelatine flex items-center rounded shadow-md overflow-hidden max-w-xl relative bg-dark-200 text-white"><div class="self-stretch flex items-center px-3 flex-shrink-0 bg-dark-300 text-primary-500"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-8 w-8"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><div class="p-4 flex-1"><p class="text-sm dark:text-gray-400">You do not have a Cardano Wallet installed!</p></div><button class="absolute top-2 right-2"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 p-2 rounded cursor-pointer"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div>`
                const temp_element = document.createElement("div")
                temp_element.innerHTML = error_html
                var fragment = document.createDocumentFragment()
                while (temp_element.firstChild) {
                    fragment.appendChild(temp_element.firstChild)
                }
                main_menu.appendChild(fragment)
            }


        }
        else {

        }
    </script>

</body>
